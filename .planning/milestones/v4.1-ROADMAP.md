# Milestone v4.1: Dependency Upgrades & Facebook Fix

**Status:** ✅ SHIPPED 2026-02-22
**Phases:** 1-2 (retroactive)
**Total Commits:** 10

## Overview

This milestone fixed the broken Facebook annotation feature by adopting Facebook's new `data-ad-rendering-role` attribute-based post detection. It also upgraded core dependencies (Plasmo, React, TypeScript, ESLint) to modern versions and added a News Search feature for Facebook posts.

## Phases (Reconstructed from Git History)

### Phase 1: Infrastructure & Dependencies

**Goal:** Upgrade core dependencies to modern versions
**Commits:** 2

Commits:
- [x] `ac35817d`: Pin Node 24 via mise, update engines
- [x] `88295060`: Upgrade core dependencies for v4.1

**Changes:**
- Plasmo 0.84.2 → 0.90.5
- React 18.2.0 → 18.3.1
- TypeScript 5.3.3 → 5.9.3
- ESLint v5.x → v8.56.0
- Node target >=20 → >=24
- Verified Manifest V3 compliance

### Phase 2: Facebook Detection Fix & News Search

**Goal:** Fix broken Facebook annotation and add News Search feature
**Commits:** 8

Commits:
- [x] `125964cc`: Fix Facebook detection to use data-ad-rendering-role
- [x] `906d5c55`: Fix narrow tailwind content pattern to src/ only
- [x] `4e3e4cdc`: Fix hide extra info row when collapsed on Facebook
- [x] `a57707df`: Fix make annotation container fill full width
- [x] `3809b634`: Fully working
- [x] `00475488`: Add role="article" fallback for Facebook post detection
- [x] `639cf698`: Add News Search button for Facebook posts
- [x] `b7340c91`: Add option to disable News Search button on Facebook

**Changes:**
- Replaced broken `div[role='article'][aria-posinset]` detection with `data-ad-rendering-role` based approach
- Domain extraction via `[data-ad-rendering-role="meta"]` textContent (primary)
- Annotation insertion before engagement block
- Added `role="article"` fallback for edge cases
- Added configurable News Search button feature

---

## Milestone Summary

**Key Decisions:**

| Decision | Rationale | Outcome |
|----------|-----------|---------|
| Use `data-ad-rendering-role` as primary post detection | Tied to Facebook's ad system, more stable than randomized CSS classes | ✓ Working |
| Keep FB page path as fallback (not primary) | `meta` domain is more direct and accurate | ✓ Working |
| Add role="article" fallback | Handles edge cases where data-ad-rendering-role might be missing | ✓ Working |
| ESLint v8 (not v9 flat config) | Less migration risk | ✓ Working |

**Issues Resolved:**

- Fixed Facebook annotation completely broken due to Facebook DOM changes
- Removed dependency on unstable `aria-posinset` attribute
- Proper domain extraction from link preview metadata
- Annotation container now fills full width correctly
- Extra info row properly hidden when collapsed

**Technical Debt:**

- None significant - clean implementation

---

## Stats

- **Timeline:** 2026-02-21 → 2026-02-22 (2 days)
- **Commits:** 10
- **Files modified:** 9
- **Lines changed:** +7,561 -5,956
- **LOC:** ~3,711 TypeScript

---

_For current project status, see .planning/PROJECT.md_
